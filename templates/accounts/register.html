{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-lg overflow-hidden" style="border-radius: 20px;">
                <div class="row g-0">
                    
                    <div class="col-lg-5 d-none d-lg-block text-white p-5 d-flex flex-column justify-content-between" 
                         style="background: linear-gradient(135deg, #198754 0%, #146c43 100%);">
                        <div>
                            <h2 class="fw-bold mb-3">Welcome!</h2>
                            <p class="opacity-75">Your bridge to better health. Connect with specialists instantly.</p>
                        </div>
                        
                        <div class="text-center">
                            <div class="bg-white rounded-circle p-3 mx-auto mb-4 d-flex align-items-center justify-content-center shadow-sm" style="width: 140px; height: 140px;">
                                <i class="fa-solid fa-hospital-user fa-4x text-success"></i>
                            </div>
                            <p class="small opacity-75">Patient-First Technology</p>
                        </div>

                        <div class="small opacity-50">
                            &copy; 2026 CareBridge Systems
                        </div>
                    </div>

                    <div class="col-lg-7 p-5 bg-white">
                        <div class="mb-4">
                            <h3 class="fw-bold text-dark">Create Account</h3>
                            <p class="text-muted small">Join our network as a new patient.</p>
                        </div>

                        {% if form.errors %}
                            <div class="alert alert-danger small rounded-3 mb-4">
                                <strong class="d-block mb-1"><i class="fa-solid fa-circle-exclamation me-1"></i> Registration Failed:</strong>
                                <ul class="mb-0 ps-3">
                                    {% for field in form %}
                                        {% for error in field.errors %}
                                            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                    {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}

                        <form method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label small fw-bold text-uppercase text-muted">First Name <span class="text-danger">*</span></label>
                                    {{ form.first_name }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label small fw-bold text-uppercase text-muted">Last Name <span class="text-danger">*</span></label>
                                    {{ form.last_name }}
                                </div>

                                <div class="col-md-12 mb-3">
                                    <label class="form-label small fw-bold text-uppercase text-muted">Username <span class="text-danger">*</span></label>
                                    {{ form.username }}
                                </div>

                                <div class="col-md-7 mb-3">
                                    <label class="form-label small fw-bold text-uppercase text-muted">Email Address <span class="text-danger">*</span></label>
                                    {{ form.email }}
                                </div>
                                <div class="col-md-5 mb-3">
                                    <label class="form-label small fw-bold text-uppercase text-muted">Phone</label>
                                    {{ form.phone_number }}
                                </div>

                                <div class="col-md-12 mb-3">
                                    <label class="form-label small fw-bold text-uppercase text-muted">Address</label>
                                    {{ form.address }}
                                </div>

                                <div class="col-md-12 mb-3">
                                    <label class="form-label small fw-bold text-uppercase text-muted">Profile Photo (Optional)</label>
                                    {{ form.profile_picture }}
                                </div>
                                
                                <div class="col-md-6 mb-3 position-relative">
                                    <label class="form-label small fw-bold text-uppercase text-muted">Password <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        {{ form.password }}
                                        <button class="btn btn-outline-secondary toggle-password" type="button" tabindex="-1">
                                            <i class="fa-solid fa-eye"></i>
                                        </button>
                                    </div>
                                    <div id="password-feedback" class="small mt-1 fw-bold" style="font-size: 0.8rem; min-height: 20px;"></div>
                                </div>

                                <div class="col-md-6 mb-3 position-relative">
                                    <label class="form-label small fw-bold text-uppercase text-muted">Confirm Password <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        {{ form.confirm_password }}
                                        <button class="btn btn-outline-secondary toggle-password" type="button" tabindex="-1">
                                            <i class="fa-solid fa-eye"></i>
                                        </button>
                                    </div>
                                    <div id="match-feedback" class="small mt-1 fw-bold" style="font-size: 0.8rem; min-height: 20px;"></div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success w-100 py-3 mt-3 shadow-sm fw-bold hover-lift" id="submitBtn" style="background-color: #198754; border:none; border-radius: 8px;">
                                Create Account
                            </button>
                        </form>

                        <div class="text-center mt-4">
                            <small class="text-muted">Already a member? <a href="{% url 'patient_login' %}" class="fw-bold text-success text-decoration-none">Sign in</a></small>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Styling Logic: Ensure inputs look correct
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('input, textarea, select').forEach(input => {
            if (!input.classList.contains('form-control') && input.type !== 'checkbox' && input.type !== 'file') {
                input.classList.add('form-control');
            }
            if(input.type === 'file') input.classList.add('form-control'); 
            
            input.style.backgroundColor = "#f9fafb";
            input.style.border = "1px solid #e5e7eb";
        });
    });

    // 2. Toggle Password Visibility
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            let input = this.parentElement.querySelector('input');
            let icon = this.querySelector('i');
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = "password";
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    });

    // 3. Password Validation & Matching
    const mainPass = document.getElementById('id_password');
    const confirmPass = document.getElementById('id_confirm_password');
    const strengthBox = document.getElementById('password-feedback');
    const matchBox = document.getElementById('match-feedback');

    if (mainPass && confirmPass) {
        mainPass.addEventListener('input', function() {
            const val = this.value;
            let errors = [];
            if (val.length === 0) { strengthBox.innerHTML = ""; return; }
            
            if (val.length < 8) errors.push("Min 8 chars");
            if (!/[A-Z]/.test(val)) errors.push("1 Uppercase");
            if (!/[0-9]/.test(val)) errors.push("1 Number");
            
            if (errors.length > 0) {
                strengthBox.className = "small mt-1 fw-bold text-danger";
                strengthBox.innerHTML = "Missing: " + errors.join(", ");
            } else {
                strengthBox.className = "small mt-1 fw-bold text-success";
                strengthBox.innerHTML = '<i class="fa-solid fa-check me-1"></i> Strong Password';
            }
            if (confirmPass.value.length > 0) checkMatch();
        });

        confirmPass.addEventListener('input', checkMatch);

        function checkMatch() {
            const val1 = mainPass.value;
            const val2 = confirmPass.value;
            if (val2.length === 0) { matchBox.innerHTML = ""; return; }
            if (val1 === val2) {
                matchBox.className = "small mt-1 fw-bold text-success";
                matchBox.innerHTML = '<i class="fa-solid fa-check-double me-1"></i> Passwords Match';
            } else {
                matchBox.className = "small mt-1 fw-bold text-danger";
                matchBox.innerHTML = '<i class="fa-solid fa-xmark me-1"></i> No Match';
            }
        }
    }
</script>

<style>
    .hover-lift:hover { transform: translateY(-2px); transition: 0.2s; }
</style>
{% endblock %}